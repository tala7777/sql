CREATE DATABASE IF NOT EXISTS ecommerce_db;
USE ecommerce_db;

CREATE TABLE cities (
    city_id INT PRIMARY KEY AUTO_INCREMENT,
    city_name VARCHAR(100) NOT NULL
);

CREATE TABLE users (
    user_id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(100) NOT NULL,
    city_id INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (city_id) REFERENCES cities(city_id)
);

CREATE TABLE orders (
    order_id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT,
    amount DECIMAL(10, 2) NOT NULL,
    order_date DATE NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users(user_id)
);

CREATE TABLE newsletter_subscribers (
    subscriber_id INT PRIMARY KEY AUTO_INCREMENT,
    email VARCHAR(100) NOT NULL UNIQUE,
    subscribed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO cities (city_name) VALUES 
('New York'), ('Los Angeles'), ('Chicago'), ('Miami'), ('Seattle');

INSERT INTO users (username, city_id) VALUES
('john_doe', 1),
('jane_smith', 1),
('mike_jones', 2),
('sara_williams', 2),
('tom_brown', 3),
('lisa_davis', 3),
('alex_wilson', 1),
('emma_taylor', 1),
('david_clark', 1),
('olivia_martin', 2),
('kevin_adams', 4),
('grace_lee', NULL);

INSERT INTO orders (user_id, amount, order_date) VALUES
(1, 150.00, '2024-01-15'),
(1, 75.50, '2024-02-20'),
(2, 200.00, '2024-01-20'),
(3, 50.00, '2024-02-10'),
(4, 300.00, '2024-03-05'),
(5, 125.00, '2024-03-15'),
(6, 80.00, '2024-03-20'),
(1, 95.00, '2024-03-25'),
(7, 60.00, '2024-03-28'),
(8, 250.00, '2024-04-01');

INSERT INTO newsletter_subscribers (email) VALUES
('john_doe@example.com'),
('new_subscriber@example.com'),
('another_sub@example.com'),
('jane_smith@example.com');

SELECT c.city_name, COUNT(u.user_id) as user_count
FROM cities c
JOIN users u ON c.city_id = u.city_id
GROUP BY c.city_id, c.city_name
HAVING COUNT(u.user_id) > 5;

SELECT u.user_id, u.username
FROM users u
LEFT JOIN orders o ON u.user_id = o.user_id
WHERE o.order_id IS NULL;

SELECT u.user_id, u.username, 
       AVG(o.amount) as avg_order_amount,
       COUNT(o.order_id) as total_orders
FROM users u
LEFT JOIN orders o ON u.user_id = o.user_id
GROUP BY u.user_id, u.username;

WITH user_spending AS (
    SELECT u.user_id, u.username, 
           SUM(o.amount) as total_spent
    FROM users u
    LEFT JOIN orders o ON u.user_id = o.user_id
    GROUP BY u.user_id, u.username
),
avg_spending AS (
    SELECT AVG(total_spent) as avg_total_spent
    FROM user_spending
    WHERE total_spent IS NOT NULL
)
SELECT us.*
FROM user_spending us, avg_spending av
WHERE us.total_spent > av.avg_total_spent;

ALTER TABLE users ADD COLUMN email VARCHAR(100);
UPDATE users SET email = CONCAT(username, '@example.com') WHERE email IS NULL;

SELECT email, 'Registered User' as source FROM users
UNION
SELECT email, 'Newsletter Subscriber' as source FROM newsletter_subscribers;